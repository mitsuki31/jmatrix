# ======================= #
#         Makefile        #
# ======================= #
# >> Created by Ryuu Mitsuki

# Recommended Make version: 4.4.*+

# WARNING! Don't change this version manually, it's autogenerated!
VERSION := 1.2.2
PREFIX  := [jmatrix]

CC := javac

# Define null variable, let user to initialize with any Java options or flags
FLAGS ?=

# Assign "true" into this variable would trigger the Java linter
# and the `FLAGS` variable automatically added linter flags "-Xlint"
LINT ?=


ALL_RULES := all compile package clean cleanbin cleandocs usage build-docs check-verbose

# Path variables
PYTHON_PATH    := ./src/main/python/
SOURCES_PATH   := ./src/main/java/
RESOURCES_PATH := ./src/main/resources/
OUTPUT_PATH    := ./target/
CLASSES_PATH   := ./target/classes/
PACKAGE_PATH   := com/mitsuki/jmatrix/
MANIFEST       := META-INF/MANIFEST.MF

MAKE_USAGE_TXC := docs/makefile-usage.txcc
MAKE_USAGE_TXT := docs/makefile-usage.txt
DOCS_PATH      := docs/jmatrix-$(VERSION)

SOURCES_LIST   := target/generated-list/sourceFiles.lst
CLASSES_LIST   := target/generated-list/outputFiles.lst

SRCFILES       := $(shell find $(SOURCES_PATH) -type f -name '*.java')
ifneq "$(wildcard $(CLASSES_PATH))" ""
	CLSFILES   := $(shell find $(CLASSES_PATH) -type f -name '*.class')
else
	CLSFILES   :=
endif

jar      := $(OUTPUT_PATH)jmatrix-$(VERSION).jar
jar_name := $(word 3,$(subst /, , $(jar)))


# Check whether the program has been compiled
HAS_OUTPUT   := $(wildcard $(OUTPUT_PATH))
HAS_COMPILED := $(wildcard $(CLASSES_PATH))

ARG1 := $(word 1,$(MAKECMDGOALS))
ifeq ($(words $(MAKECMDGOALS)),2)
    ARG2 := $(word 2,$(MAKECMDGOALS))
endif


# Check VERBOSE variable from shell
ifndef VERBOSE
	MAKE_VERBOSE :=
else
ifeq "$(VERBOSE)" "true"
	MAKE_VERBOSE := true
else
	MAKE_VERBOSE :=
endif
endif


# Define null variable, user should defines it on CLI arguments
# if want to activate it (the value should "true")
INCLUDE-SRC ?=


ifeq "$(ARG1)" "clean"
ifeq "$(strip $(HAS_OUTPUT))" ""
$(error $(PREFIX) Program is uncompiled, failed to clean working directory)
endif
endif

ifeq "$(ARG1)" "cleanbin"
ifeq "$(strip $(HAS_COMPILED))" ""
$(error $(PREFIX) Program is uncompiled, failed to clean classes directory)
endif
endif


# Get the index of "build-docs" rule on command line args
ifeq "$(filter build-docs,$(MAKECMDGOALS))" "build-docs"
ifdef VERBOSE
	CMD = bash bin/get_argument.sh -v $(MAKECMDGOALS) -s build-docs
else
	CMD = bash bin/get_argument.sh $(MAKECMDGOALS) -s build-docs
endif

BUILD_DOCS_ARG := $(shell $(CMD))


# Check if the "build-docs"'s index is not at first argument,
# then it will returns error
ifneq "$(BUILD_DOCS_ARG)" "-1"
ifneq "$(words $(MAKECMDGOALS))" "1"
$(error $(PREFIX) 'build-docs' rule must be a standalone rule)
endif
endif

endif

# This to prevent all `Make`'s rules treated as file by default
.PHONY: $(ALL_RULES)


all:
	$(info [Makefile-jmatrix])
# This check whether the user using Bash as shell environment or else
# On Bash shell it will have OSTYPE as built-in variable
ifneq "$$OSTYPE" ""
ifneq "$(wildcard $(MAKE_USAGE_TXC))" "$(MAKE_USAGE_TXC)"
	$(error $(PREFIX) File "$(MAKE_USAGE_TXC)" is missing)
endif
# The color coded only works on Bash shell, on CMD neither Powershell
# it would not display the prefixes color codes.
	@cat $(MAKE_USAGE_TXC)
else
ifneq "$(wildcard $(MAKE_USAGE_TXT))" "$(MAKE_USAGE_TXT)"
	$(error $(PREFIX) File "$(MAKE_USAGE_TXT)" is missing)
endif

	@cat $(MAKE_USAGE_TXT)
endif

check-verbose:
ifneq "$(MAKE_VERBOSE)" "true"
	@echo "Verbose output is DEACTIVATED."
else
	@echo "Verbose output is ACTIVATED."
endif



compile: $(SOURCES_LIST) $(SRCFILES)
	@echo ""
	@echo ">> [ COMPILE PROGRAM ] <<"

ifeq "$(LINT)" "true"
	@echo "$(PREFIX) Linter is ACTIVATED."
	$(eval LINT_FLAGS := -Xlint -Xdoclint)
else
	$(eval LINT_FLAGS :=)
endif

ifeq "$(MAKE_VERBOSE)" "true"
	@echo "$(PREFIX) Verbose output is ACTIVATED."
	$(eval VERBOSE_FLAGS := -verbose)
else
	$(eval VERBOSE_FLAGS :=)
endif

	@echo "$(PREFIX) Compiling all source files..."
	@$(CC) -d $(CLASSES_PATH) @$< $(LINT_FLAGS) $(VERBOSE_FLAGS) $(FLAGS)
	@echo "$(PREFIX) Successfully compiled all source files."

	$(eval HAS_COMPILED := $(wildcard $(CLASSES_PATH)))
	$(eval HAS_OUTPUT := $(wildcard $(OUTPUT_PATH)))

	@echo ""
	@echo ">> [ GENERATE LIST ] <<"
	@echo "$(PREFIX) Generating list of class files..."

ifeq "$(MAKE_VERBOSE)" "true"
	@python $(PYTHON_PATH)generate_list.py cls -v
else
	@python $(PYTHON_PATH)generate_list.py cls
endif

	@echo "$(PREFIX) List file generated."


package: $(CLSFILES)
	$(if $(shell [ ! -d $(CLASSES_PATH) ] && echo "1"),\
		$(error $(PREFIX) Program is uncompiled, compile it with `make compile` command)\
	)

	@echo ""
	@echo ">> [ CREATE JAR ] <<"

	@echo "$(PREFIX) Copying all program resources to output directory..."
	@cp -r --preserve=all $(RESOURCES_PATH)* $(CLASSES_PATH)
	@echo "$(PREFIX) All resources have been copied."

	@echo ""
	@echo "$(PREFIX) Creating jar for compiled classes..."

ifeq "$(MAKE_VERBOSE)" "true"
	@python $(PYTHON_PATH)fix_config.py -v
	@jar cvfm $(jar) $(MANIFEST) \
	    LICENSE -C $(CLASSES_PATH) .
else
	@python $(PYTHON_PATH)fix_config.py
	@jar cfm $(jar) $(MANIFEST) \
		LICENSE -C $(CLASSES_PATH) .
endif

ifeq "$(INCLUDE-SRC)" "true"
	@echo ""
	@echo "$(PREFIX) INCLUDE-SRC option is ACTIVATED"
	@echo "$(PREFIX) Adding the source files into jar..."
ifeq "$(MAKE_VERBOSE)" "true"
	@jar uvf $(jar) -C $(SOURCES_PATH) .
else
	@jar uf $(jar) -C $(SOURCES_PATH) .
endif
endif

	@echo "$(PREFIX) Successfully created the jar file."
	@echo ""
	@echo "SAVED IN: \"$(jar)\""


build-docs: $(SOURCES_LIST)
	@echo
ifndef VERBOSE
	@echo "$(PREFIX) Verbose mode: QUIET"
	$(eval VERBOSE_FLAGS := -quiet)
else

# Check whether the VERBOSE's value is "true"
ifeq "$(VERBOSE)" "true"
	@echo "$(PREFIX) Verbose mode: NORMAL"
	$(eval VERBOSE_FLAGS :=)
endif

# Check whether the VERBOSE's value is "all"
ifeq "$(VERBOSE)" "all"
	@echo "$(PREFIX) Verbose mode: ALL"
	$(eval VERBOSE_FLAGS := -verbose)
endif

# Check whether the VERBOSE's value is "false"
ifeq "$(VERBOSE)" "false"
	@echo "$(PREFIX) Verbose mode: QUIET"
	$(eval VERBOSE_FLAGS := -quiet)
endif

# If VERBOSE's value does not match with (all, true, false)
# then the verbose mode would be override to NORMAL mode.
ifneq "$(shell \
    [ $(VERBOSE) = 'all' ] || [ $(VERBOSE) = 'true' ] || [ $(VERBOSE) != 'false' ] && echo 'false'\
)" "false"
	@echo "$(PREFIX) Verbose mode: NORMAL"
	$(eval VERBOSE_FLAGS :=)
endif
endif

	@echo
	@echo ">> [ BUILD DOCS ] <<"
	@echo "$(PREFIX) Build the JMatrix docs..."
	@javadoc -author -version -d $(DOCS_PATH) -locale en -docencoding "UTF-8" -keywords -Xdoclint:all \
		@$^ -windowtitle "JMatrix API" -protected -exclude com.mitsuki.jmatrix.util:com.mitsuki.jmatrix.util.* \
		-tag param -tag return -tag throws -tag warning:a:"Warning:" -tag author -tag license:a:"License:" -tag see \
		-bottom "Copyright (C) 2023 <a href="https://github.com/mitsuki31">Ryuu Mitsuki</a>. All rights reserved." \
		$(VERBOSE_FLAGS) $(FLAGS)

	@echo "$(PREFIX) Successfully build the JMatrix docs."
	@echo
	@echo "SAVED IN: \"$(DOCS_PATH)/\""

clean:
# Check whether the verbose is activated
ifeq "$(MAKE_VERBOSE)" "true"
	$(eval VERBOSE_FLAGS := -v)
else
	$(eval VERBOSE_FLAGS :=)
endif

	@echo ""
	@echo ">> [ CLEAN WORKING DIRECTORY ] <<"
	@echo "$(PREFIX) Cleaning the \"$(subst ./,,$(OUTPUT_PATH))\" directory recursively..."

	@-rm -r $(OUTPUT_PATH) $(VERBOSE_FLAGS)
	@echo "$(PREFIX) Classes directory cleaned up."

# Clean the temporary directory "tmp/", only if exist
	$(if $(shell [ -d tmp/ ] && echo 1),\
		@echo && echo "$(PREFIX) Cleaning the \"tmp/\" directory recursively..." &&\
		rm -r tmp $(VERBOSE_FLAGS) &&\
		echo "$(PREFIX) Temporary directory cleaned up."\
	)

# Clean the generated HTML pages directory "docs/jmatrix/", only if exist
	$(if $(shell [ -d $(DOCS_PATH) ] && echo 1),\
		@echo && echo "$(PREFIX) Cleaning the \"$(DOCS_PATH)/\" directory recursively..." &&\
		rm -r $(DOCS_PATH) $(VERBOSE_FLAGS) &&\
		echo "$(PREFIX) Generated HTML pages cleaned up."\
	)
	@echo ""
	@echo "$(PREFIX) All cleaned up."


cleanbin:
# Check whether the verbose is activated
ifeq "$(MAKE_VERBOSE)" "true"
	$(eval VERBOSE_FLAGS := -v)
else
	$(eval VERBOSE_FLAGS :=)
endif

	@echo ""
	@echo ">> [ CLEAN ONLY THE CLASS OBJECTS ] <<"
	@echo "$(PREFIX) Cleaning the class files..."
	@-rm -r $(CLASSES_PATH) $(VERBOSE_FLAGS)
	@echo ""
	@echo "$(PREFIX) All cleaned up."

	$(if $(shell test -f $(jar) && echo "1"),\
		@echo 'File "$(subst ./,,$(jar))" is still exists.',\
		@echo 'File "$(subst ./,,$(jar))" is missing or has been deleted.'\
	)

cleandocs:
# Check whether the verbose is activated
ifeq "$(MAKE_VERBOSE)" "true"
	$(eval VERBOSE_FLAGS := -v)
else
	$(eval VERBOSE_FLAGS :=)
endif

	$(info )
	$(info >> [ CLEAN ONLY THE GENERATED DOCS ] <<)

# Check whether the `docs/jmatrix` directory is exist
ifeq "$(shell [ -d $(DOCS_PATH) ] && echo 1)" "1"
	@echo "$(PREFIX) Cleaning the generated HTML pages..."
	@-rm -r $(DOCS_PATH) $(VERBOSE_FLAGS)
else
# Send warning message if the directory does not exist
	$(warning $(PREFIX) No such file or directory: "$(subst ./,,$(DOCS_PATH))")
endif

	@echo
	@echo "$(PREFIX) All cleaned up."


$(SOURCES_LIST): $(wildcard $(PYTHON_PATH)*.py)
	@echo ""
	@echo ">> [ GENERATE LIST ] <<"
	@echo "$(PREFIX) Generating list of source files..."

ifeq "$(MAKE_VERBOSE)" "true"
	@python $(PYTHON_PATH)generate_list.py src -v
else
	@python $(PYTHON_PATH)generate_list.py src
endif

	@echo "$(PREFIX) List file generated."


usage:
	@echo "[Makefile Basic Usage]"

	@echo ""
	@echo "Parameters:"
	@echo "    $$ make [option1] [option2] [...]"

	@echo ""
	@echo "Generate \"jar\" file (simple)"
	@echo ""
	@echo "make"
	@echo "  └── compile"
	@echo "          └── package"
	@echo "                 └── cleanbin (optional)"

	@echo ""
	@echo "Generate \"jar\" file (complex)"
	@echo ""
	@echo "make"
	@echo "  └── compile"
	@echo "         └── package"
	@echo "                └── && mv target/*.jar ."
	@echo "                       └── && make"
	@echo "                                └── clean"
